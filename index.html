<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permit Mengajar Pahang - Latihan Mengajar KPM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .loader {
            border: 4px solid #e5e7eb; /* gray-200 */
            border-top: 4px solid #2563eb; /* blue-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            white-space: nowrap;
            border-radius: 9999px;
        }
        .status-new {
            color: #a16207; /* yellow-700 */
            background-color: #fef9c3; /* yellow-100 */
        }
        .status-approved {
            color: #166534; /* green-800 */
            background-color: #dcfce7; /* green-100 */
        }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .nav-link-inactive {
            color: #cbd5e1; /* slate-300 */
        }
        .nav-link-inactive:hover {
            background-color: #334155; /* slate-700 */
            color: #ffffff;
        }
        .nav-link-active {
            color: #ffffff;
            background-color: #2563eb; /* blue-600 */
        }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; }
        .prose h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 700; }
    </style>
</head>
<body class="text-slate-800">

    <div class="flex flex-col md:flex-row min-h-screen bg-slate-100">
        <!-- Left Side Navigation -->
        <aside class="w-full md:w-64 bg-slate-800 text-white flex-shrink-0">
            <div class="p-6 flex items-center justify-center">
                <img src="ImejJPNPutih.png" alt="Logo JPN Pahang" class="h-24 w-auto">
            </div>
            <nav class="p-4 space-y-2">
                <button id="introTab" class="nav-link w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span>Pengenalan</span>
                </button>
                <button id="publicTab" class="nav-link w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                <span>Borang Permohonan</span>
                </button>
                <!-- New Tab: Manual MySTEP -->
                <button id="manualTab" class="nav-link w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>
                    <span>Manual MySTEP</span>
                </button>
                <button id="adminTab" class="nav-link w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>
                    <span>Pentadbir Sistem</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <header class="bg-white shadow-sm rounded-xl p-6 mb-8">
                 <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">Permit Mengajar Pahang</h1>
                 <p class="text-slate-600 mt-1">Sistem Permohonan Permit Mengajar untuk Program Latihan Mengajar KPM</p>
            </header>
            
            <main>
                <!-- Introduction View -->
                <div id="introductionView" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Selamat Datang ke Portal Permit Mengajar Pahang</h2>
                    <div class="prose max-w-none text-slate-600 space-y-4">
                        <p>Portal ini adalah platform rasmi bagi permohonan permit mengajar di bawah program Latihan Mengajar oleh Kementerian Pendidikan Malaysia (KPM) untuk negeri Pahang. Ia direka untuk memudahkan proses permohonan bagi bakal guru dan pengurusan data bagi pihak pentadbir.</p>
                        <h3 class="text-slate-800">Mengenai MySTEP</h3>
                        <p>MySTEP (Short-term Employment Programme) adalah inisiatif kerajaan untuk memberi peluang pekerjaan jangka pendek di Sektor Awam dan Syarikat Berkaitan Kerajaan (GLC) kepada warganegara Malaysia. Melalui program ini, peserta akan mendapat pengalaman kerja untuk meningkatkan kebolehpasaran mereka.</p>
                        <h3 class="text-slate-800">Cara Memohon</h3>
                        <ol>
                            <li>Navigasi ke tab <strong>Borang Permohonan</strong> di sebelah kiri.</li>
                            <li>Lengkapkan semua maklumat yang diperlukan di dalam borang Google Form yang disediakan.</li>
                            <li>Pastikan semua dokumen sokongan dilampirkan dengan betul.</li>
                            <li>Hantar permohonan anda dan tunggu maklum balas daripada pihak pentadbir.</li>
                        </ol>
                        <p>Para pentadbir boleh log masuk melalui tab <strong>Pentadbir Sistem</strong> untuk mengakses papan pemuka, menyemak permohonan, dan menjana permit mengajar.</p>
                    </div>
                </div>

                <!-- Manual MySTEP View -->
                <div id="manualView" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 text-center">Manual dan Panduan Permohonan MySTEP</h2>
                    <div class="prose max-w-none text-slate-600 space-y-4 mb-8 text-center">
                        <p>Halaman ini akan menyediakan link ke bahagian Carta Alir dan Manual dalam proses mengisi serta menguruskan Permit MySTEP ini. Sila klik butang di bawah untuk rujukan penuh mengenai langkah-langkah permohonan, dokumen yang diperlukan, dan soalan lazim.</p>
                    </div>
                    <div class="flex justify-center mt-8">
                        <a href="#" class="inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            <span> Manual MySTEP</span>
                        </a>
                    </div>
                </div>

                <!-- Public View: Google Form -->
                <div id="publicView" class="hidden bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-2 text-center text-slate-900">Borang Permohonan Permit Mengajar</h2>
                    <p class="text-center text-slate-600 mb-6">Sila lengkapkan borang di bawah. Pastikan semua maklumat adalah tepat.</p>
                    <div class="w-full max-w-4xl mx-auto">
                        <div class="relative h-0" style="padding-bottom: 120%;">
                             <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSd5dwtMW5mO8eqmg8CnKWJzm3DoaDOkyICYGFCQSKwdtF-3qw/viewform?embedded=true" class="absolute top-0 left-0 w-full h-full border-0 rounded-lg" >Memuatkanâ€¦</iframe>
                        </div>
                    </div>
                </div>

                <!-- Admin Login View -->
                <div id="loginView" class="hidden bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-center text-slate-900">Akses Pentadbir Sistem</h2>
                    <div id="loginError" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-md" role="alert">
                        <p class="font-bold">Log Masuk Gagal</p>
                        <p>ID Pentadbir atau Kata Laluan tidak sah.</p>
                    </div>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="adminId" class="block text-sm font-medium text-slate-700 mb-1">ID Pentadbir</label>
                            <input type="text" id="adminId" class="block w-full px-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., SPS123">
                        </div>
                        <div>
                            <label for="adminPassword" class="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label>
                            <input type="password" id="adminPassword" class="block w-full px-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">Log Masuk</button>
                    </form>
                </div>

                <!-- Admin Dashboard View -->
                <div id="adminView" class="hidden">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-slate-900">Dashboard Pentadbir</h2>
                         <div class="flex items-center gap-4">
                            <button id="refreshButton" class="flex items-center justify-center gap-2 bg-white hover:bg-slate-100 border border-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                Muat Semula Data
                            </button>
                            <button id="logoutButton" class="flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                                Log Keluar
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                            <div>
                                <h3 class="text-slate-500 font-semibold">Jumlah Permohonan</h3>
                                <p id="totalApps" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-amber-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg></div>
                            <div>
                                <h3 class="text-slate-500 font-semibold">Jumlah Sekolah Terlibat</h3>
                                <p id="totalSchools" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-slate-900">Senarai Permohonan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="relative md:col-span-1">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <input type="text" id="searchInput" class="block w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg" placeholder="Cari nama/sekolah...">
                            </div>
                            <select id="districtFilter" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-white">
                                <option value="">Semua Daerah</option>
                            </select>
                            <select id="categoryFilter" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-white">
                                <option value="">Semua Kategori</option>
                                <option value="MENENGAH">Menengah</option>
                                <option value="RENDAH">Rendah</option>
                            </select>
                        </div>
                        <div id="loader" class="flex justify-center items-center py-10">
                            <div class="loader"></div>
                            <p class="ml-4 text-slate-600">Memuatkan data, sila tunggu...</p>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table id="mainTable" class="hidden w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Nama Penuh</th>
                                        <th scope="col" class="px-6 py-3">Sekolah</th>
                                        <th scope="col" class="px-6 py-3">Daerah</th>
                                        <th scope="col" class="px-6 py-3">Tarikh Mula</th>
                                        <th scope="col" class="px-6 py-3">Tarikh Tamat</th>
                                        <th scope="col" class="px-6 py-3 text-center">Status</th>
                                        <th scope="col" class="px-6 py-3 text-center">Permit</th>
                                    </tr>
                                </thead>
                                <tbody id="mainTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-center text-slate-900">Taburan Permohonan Mengikut Daerah</h3>
                            <div class="chart-container">
                                 <canvas id="districtChart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-center text-slate-900">Pecahan Kategori Sekolah</h3>
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyj57hooyC0lr55TPmdTlLKtChY9XnTYNuLiiYHz6LADtCd41eWGhODSQliWxilo7tThA/exec';
            let allData = [];
            let districtChartInstance, categoryChartInstance;

            // Tabs and Views
            const introTab = document.getElementById('introTab');
            const publicTab = document.getElementById('publicTab');
            const adminTab = document.getElementById('adminTab');
            const manualTab = document.getElementById('manualTab'); // New tab
            const introductionView = document.getElementById('introductionView');
            const publicView = document.getElementById('publicView');
            const loginView = document.getElementById('loginView');
            const adminView = document.getElementById('adminView');
            const manualView = document.getElementById('manualView'); // New view

            // Admin elements
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('loginError');
            const logoutButton = document.getElementById('logoutButton');
            const refreshButton = document.getElementById('refreshButton');
            const loader = document.getElementById('loader');
            const mainTable = document.getElementById('mainTable');
            const mainTableBody = document.getElementById('mainTableBody');
            const totalApps = document.getElementById('totalApps');
            const totalSchools = document.getElementById('totalSchools');
            const searchInput = document.getElementById('searchInput');
            const districtFilter = document.getElementById('districtFilter');
            const categoryFilter = document.getElementById('categoryFilter');

            // Event Listeners
            introTab.addEventListener('click', () => showView('introduction'));
            publicTab.addEventListener('click', () => showView('public'));
            manualTab.addEventListener('click', () => showView('manual')); // New listener
            adminTab.addEventListener('click', () => {
                const isAdminViewVisible = !adminView.classList.contains('hidden');
                showView(isAdminViewVisible ? 'admin' : 'login');
            });
            
            refreshButton.addEventListener('click', () => {
                allData = []; // Clear cache
                loadAdminData();
            });

            [searchInput, districtFilter, categoryFilter].forEach(el => {
                el.addEventListener('input', applyFilters);
                el.addEventListener('change', applyFilters);
            });


            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const adminId = document.getElementById('adminId').value;
                const adminPassword = document.getElementById('adminPassword').value;
                if (adminId === 'SPS123' && adminPassword === '12345') {
                    loginError.classList.add('hidden');
                    showView('admin');
                    loadAdminData();
                } else {
                    loginError.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', () => {
                showView('introduction');
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                allData = [];
                if(districtChartInstance) districtChartInstance.destroy();
                if(categoryChartInstance) categoryChartInstance.destroy();
            });

            function showView(viewName) {
                // Hide all main content views
                [introductionView, publicView, loginView, adminView, manualView].forEach(v => v.classList.add('hidden'));
                
                // Deactivate all tabs
                [introTab, publicTab, adminTab, manualTab].forEach(t => {
                    t.classList.remove('nav-link-active');
                    t.classList.add('nav-link-inactive');
                });
                
                let viewToShow, tabToActivate;

                switch(viewName) {
                    case 'public':
                        viewToShow = publicView;
                        tabToActivate = publicTab;
                        break;
                    case 'manual': // New case for manual view
                        viewToShow = manualView;
                        tabToActivate = manualTab;
                        break;
                    case 'login':
                        viewToShow = loginView;
                        tabToActivate = adminTab;
                        break;
                    case 'admin':
                        viewToShow = adminView;
                        tabToActivate = adminTab;
                        break;
                    case 'introduction':
                    default:
                        viewToShow = introductionView;
                        tabToActivate = introTab;
                        break;
                }

                viewToShow.classList.remove('hidden');
                tabToActivate.classList.add('nav-link-active');
                tabToActivate.classList.remove('nav-link-inactive');
            }
            
            async function loadAdminData() {
                if (allData.length > 0) {
                    applyFilters();
                    return;
                }
                loader.style.display = 'flex';
                mainTable.classList.add('hidden');
                
                try {
                    const response = await fetch(`${WEB_APP_URL}?cache_bust=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`Network response was not ok`);
                    const rawData = await response.json(); 
                    // Skip the first data row (row 2 in sheet, considered test data)
                    const slicedData = rawData.slice(1);
                    allData = slicedData.filter(row => row['NAMA PENUH PEMOHON'] && row['NAMA PENUH PEMOHON'].toString().trim() !== '');
                    
                    populateFilters(allData);
                    applyFilters();
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loader.innerHTML = '<p class="text-red-500 font-bold">Gagal memuatkan data. Sila pastikan URL Aplikasi Web adalah betul dan boleh diakses.</p>';
                } finally {
                     loader.style.display = 'none';
                     mainTable.classList.remove('hidden');
                }
            }

            function updateUI(data) {
                updateSummaryCards(data);
                renderTable(data);
                renderCharts(data);
            }
            
            function updateSummaryCards(data) {
                const uniqueSchools = [...new Set(data.map(item => item['NAMA SEKOLAH']).filter(Boolean))];
                totalApps.textContent = data.length;
                totalSchools.textContent = uniqueSchools.length;
            }
            
            function populateFilters(data) {
                const districts = [...new Set(data.map(item => item.DAERAH).filter(Boolean))];
                districts.sort();
                districtFilter.innerHTML = '<option value="">Semua Daerah</option>';
                districts.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d;
                    option.textContent = d;
                    districtFilter.appendChild(option);
                });
            }

            function formatDateToDDMMMYYYY(dateString) {
                if (!dateString || typeof dateString !== 'string' || dateString.trim() === '') return 'N/A';
                const months = ["JAN", "FEB", "MAC", "APR", "MEI", "JUN", "JUL", "OGO", "SEP", "OKT", "NOV", "DIS"];
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    const day = date.getDate();
                    const monthIndex = date.getMonth();
                    const year = date.getFullYear();
                    return `${day}-${months[monthIndex]}-${year}`;
                }
                const cleanDateString = dateString.split(' ')[0];
                if (cleanDateString.includes('/')) {
                    const parts = cleanDateString.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const monthIndex = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        if (!isNaN(day) && !isNaN(monthIndex) && !isNaN(year) && monthIndex >= 0 && monthIndex < 12) {
                             return `${day}-${months[monthIndex]}-${year}`;
                        }
                    }
                }
                const parts = dateString.split('-');
                if(parts.length === 3 && isNaN(parseInt(parts[1], 10))) return dateString.toUpperCase();
                return 'N/A';
            }

            function renderTable(data) {
                mainTableBody.innerHTML = ''; 
                if (data.length === 0) {
                    mainTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-slate-500">Tiada data ditemui sepadan dengan tapisan semasa.</td></tr>';
                    return;
                }
                data.slice().reverse().forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b border-slate-200 hover:bg-slate-50';
                    const hasPermit = row['NO PERMIT'] && row['NO PERMIT'].toString().trim() !== '';
                    const status = hasPermit ? 'DILULUSKAN' : 'BAHARU';
                    const statusClass = hasPermit ? 'status-approved' : 'status-new';
                    const permitUrl = row['Merged Doc URL - PERMIT MySTEP'] || '#';
                    const downloadButtonClass = hasPermit ? 'bg-green-600 hover:bg-green-700 focus:ring-green-500' : 'bg-slate-300 cursor-not-allowed';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900">${row['NAMA PENUH PEMOHON'] || 'N/A'}</td>
                        <td class="px-6 py-4">${row['NAMA SEKOLAH'] || 'N/A'}</td>
                        <td class="px-6 py-4">${row['DAERAH'] || 'N/A'}</td>
                        <td class="px-6 py-4">${formatDateToDDMMMYYYY(row['TARIKH MULA LATIHAN MENGAJAR'])}</td>
                        <td class="px-6 py-4">${formatDateToDDMMMYYYY(row['TARIKH TAMAT LATIHAN MENGAJAR'])}</td>
                        <td class="px-6 py-4 text-center"><span class="status-badge ${statusClass}">${status}</span></td>
                        <td class="px-6 py-4 text-center">
                            <a href="${permitUrl}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 text-white font-bold py-1.5 px-3 rounded-md text-xs transition-colors duration-300 ${downloadButtonClass} focus:outline-none focus:ring-2 focus:ring-offset-2" ${!hasPermit ? 'onclick="return false;"' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Permit
                            </a>
                        </td>`;
                    mainTableBody.appendChild(tr);
                });
            }

            function renderCharts(data) {
                renderDistrictChart(data);
                renderCategoryChart(data);
            }

            function renderDistrictChart(data) {
                const ctx = document.getElementById('districtChart').getContext('2d');
                const districtCounts = data.reduce((acc, row) => {
                    const district = row['DAERAH'] || 'Tidak Dinyatakan';
                    acc[district] = (acc[district] || 0) + 1;
                    return acc;
                }, {});
                if (districtChartInstance) districtChartInstance.destroy();
                districtChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(districtCounts),
                        datasets: [{
                            label: 'Jumlah Permohonan',
                            data: Object.values(districtCounts),
                            backgroundColor: 'rgba(37, 99, 235, 0.7)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }

            function renderCategoryChart(data) {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                const categoryCounts = data.reduce((acc, row) => {
                    const category = row['KATEGORI SEKOLAH'] || 'Tidak Dinyatakan';
                    acc[category] = (acc[category] || 0) + 1;
                    return acc;
                }, {});
                if (categoryChartInstance) categoryChartInstance.destroy();
                categoryChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryCounts),
                        datasets: [{
                            data: Object.values(categoryCounts),
                            backgroundColor: ['rgba(2, 132, 199, 0.7)', 'rgba(217, 70, 239, 0.7)','rgba(245, 158, 11, 0.7)'],
                            borderColor: ['#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedDistrict = districtFilter.value;
                const selectedCategory = categoryFilter.value;

                const filteredData = allData.filter(row => {
                    const name = (row['NAMA PENUH PEMOHON'] || '').toLowerCase();
                    const school = (row['NAMA SEKOLAH'] || '').toLowerCase();
                    
                    const matchesSearch = !searchTerm || name.includes(searchTerm) || school.includes(searchTerm);
                    const matchesDistrict = !selectedDistrict || row['DAERAH'] === selectedDistrict;
                    const matchesCategory = !selectedCategory || row['KATEGORI SEKOLAH'] === selectedCategory;

                    return matchesSearch && matchesDistrict && matchesCategory;
                });
                updateUI(filteredData);
            }

            showView('introduction'); // Start on introduction page
        });
    </script>
</body>
</html>


